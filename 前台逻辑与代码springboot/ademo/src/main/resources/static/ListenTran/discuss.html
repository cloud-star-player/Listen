<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>评论</title>
    <script type="text/javascript">
        document.addEventListener('plusready', function () {
            //console.log("所有plus api都应该在此事件发生后调用，否则会出现plus is undefined。"

        });
    </script>
</head>
<link href="./css/common.css" type="text/css" rel="stylesheet"/>
<link href="./css/discuss.css" type="text/css" rel="stylesheet"/>
<link rel="stylesheet" href="./lib/layui/css/layui.css" media="all">
<link type="text/css" rel="stylesheet" href="./css/swiper.min.css">
<script type="text/javascript" src="./js/new_file.js"></script>
<body>
<div class="top">
    <a href="javascript:history.back()"><svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 1024 1024" width="200" height="200" t="1574580567312" p-id="5377" version="1.1"><path fill="#ffffff" d="M 766.862 1021.72 c -10.24 0 -20.594 -3.64 -28.444 -10.922 L 228.693 538.396 c -15.701 -14.563 -15.701 -38.229 0 -52.792 L 738.418 13.198 c 15.701 -14.563 41.187 -14.563 56.889 0 c 15.701 14.564 15.701 38.23 0 52.793 L 314.027 512 l 481.28 446.009 c 15.701 14.563 15.701 38.23 0 52.793 c -7.851 7.282 -18.205 10.922 -28.445 10.922 Z" p-id="5378" /></svg></a>
    <h2>评论</h2>
    <a href="#"><span> </span></a>
</div>
<div class="up">

</div>
<div class="daodi">
    @^@已经到底啦,快快评论吧
</div>
<div class="footer">
    <a href="./my.html" class="f1"></a>
    <div class="footer_svg">
        <input type="text" placeholder="期待您的评论" class="dcontent">
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" id="tijiao" class="icon" viewBox="0 0 1024 1024" width="200" height="200"
         t="1577428747247" p-id="5256" version="1.1">
        <path fill=""
              d="M 964.155 81.861 c -9.377 -5.983 -21.387 -6.144 -30.867 -0.38 L 60.46 609.104 a 29.224 29.224 0 0 0 -13.897 28.643 c 1.419 11.454 9.45 21.007 20.465 24.371 l 273.028 83.486 l 35.767 177.664 a 29.286 29.286 0 0 0 19.368 21.957 a 29.189 29.189 0 0 0 9.318 1.522 a 29.293 29.293 0 0 0 19.383 -7.344 l 141.283 -124.957 l 289.997 88.678 a 29.043 29.043 0 0 0 8.557 1.287 a 29.28 29.28 0 0 0 16.092 -4.812 a 29.351 29.351 0 0 0 13.005 -21.241 l 84.67 -768.644 a 29.257 29.257 0 0 0 -13.341 -27.853 Z m -540.98 780.07 l -19.5 -96.886 l 95.89 29.33 l -76.39 67.555 Z m 415.35 -25.089 L 475.252 725.767 l 294.107 -345 c 5.237 -6.144 4.52 -15.375 -1.638 -20.612 c -6.13 -5.251 -15.39 -4.52 -20.612 1.639 L 444.782 716.449 l -298.028 -91.121 l 766.083 -463.112 l -74.313 674.626 Z"
              p-id="5257"/>
        <path fill=""
              d="M 812.237 580.857 c 0.614 0.087 1.214 0.117 1.814 0.117 c 7.285 0 13.59 -5.427 14.497 -12.83 l 2.72 -21.942 c 0.995 -8.031 -4.695 -15.331 -12.712 -16.311 c -8.001 -1.068 -15.316 4.71 -16.31 12.712 l -2.721 21.943 c -0.995 8.03 4.71 15.33 12.712 16.31 Z M 792.737 737.221 c 0.702 0.103 1.404 0.147 2.092 0.147 c 7.153 0 13.414 -5.252 14.467 -12.552 l 14.03 -97.88 c 1.14 -8.001 -4.419 -15.403 -12.42 -16.559 c -7.93 -1.126 -15.39 4.418 -16.56 12.42 l -14.029 97.88 c -1.126 8.001 4.433 15.389 12.42 16.544 Z"
              p-id="5258"/>
    </svg>
</div>
</body>
</html>
<script type="text/javascript">
    var user_id = localStorage.getItem("user_id");
    var music_id=localStorage.getItem("music_id");
    $(window).load(function () {
        function gettime(t){
            var _time=new Date(t);
            var   year=_time.getFullYear();//2017
            var   month=_time.getMonth()+1;//7
            var   date=_time.getDate();//10
            var   hour=_time.getHours();//10
            var   minute=_time.getMinutes();//56
            var   second=_time.getSeconds();//15
            return   year+"年"+month+"月"+date+"日   "+hour+":"+minute+":"+second;//这里自己按自己需要的格式拼接
        }
        $('body').css('height', $(window).height());
        $.ajax({
            type: "post",
            url: "/discussall/"+music_id+"/" + user_id,                        //音乐id
            dataType: "json",
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                var discuss = "";
                var dete="";
                for (var i = 0; i < data.length; i++) {
                    var timestr=gettime(data[i].discuss_date);
                    if(data[i].discuss_user_id==user_id){

                        dete=`<div class="dete">删除</div>`;
                    }
                    else{
                        dete=``;
                    }
                    if (data[i].dsta == 0) {
                        discuss += `
				<div class="pinglun">
				<div class="xuanze">
					<img src="/ShowImagetouxiang/${data[i].touimage}">
					<div class="l1">
					<div class="l2">
					<h5>${data[i].user.user_name}</h5>
					<h8>${timestr}</h8>
					</div>
					</div>
				</div>
				<p class="d_context">
					${data[i].discuss_content}
				</p>
				<div class="d_huifu">
					<a href="reply.html" class="d_hui">${data[i].dcount}回复></a>
					<div class="d_di_di">
					    <img src="img/dianzanbai.svg" id="d1">
					     <input type="hidden" id="d2" value="${data[i].discuss_id}">
					     <input type="hidden" id="d3" value="0">
					    <a class="d11" value="${data[i].discuss_id}">${data[i].dzan}</a>
					</div>
				</div>
				${dete}
				<input type="hidden" value="${data[i].discuss_id}" id="dete2">
			</div>`
                    } else {
                        discuss += `
				<div class="pinglun">
				<div class="xuanze">
					<img src="/ShowImagetouxiang/${data[i].touimage}">
					<div class="l1">
					<div class="l2">
					<h5>${data[i].user.user_name}</h5>
					<h8>${timestr}</h8>
					</div>
					</div>
				</div>
				<p class="d_context">
					${data[i].discuss_content}
				</p>
				<div class="d_huifu">
					<a href="reply.html" class="d_hui">${data[i].dcount}回复></a>
					<div class="d_di_di">
					    <img src="img/dianzanred.svg" id="d1">
					    <input type="hidden" id="d2" value="${data[i].discuss_id}">
					    <input type="hidden" id="d3" value="1">
					    <a class="d11">${data[i].dzan}</a>
					</div>
				</div>
				${dete}
				<input type="hidden" value="${data[i].discuss_id}" id="dete2">
			</div>`
                    }
                }
                $.ajax({
                    type:"post",
                    url:"/findUserall/"+user_id,
                    dataType : "json",
                    contentType : "application/json;charset=UTF-8",
                    success:function(data) {
                        var i="";
                        i=`<img src="/ShowImagetouxiang/${data.touxiang.touxiang_image}" class="touxiang11">`;
                        $('.f1').append(i);
                    }
                })
                $('.up').append(discuss);
                $(".d_hui").click(function () {
                    var t=$(this).next('.d_di_di').children("#d2").val();
                    t=parseInt(t);
                    localStorage.setItem("discuss_id",t);
                })
                $('.dete').click(function () {
                    var discuss_id=$(this).next('#dete2').val();
                    alert(discuss_id);
                    $.ajax({
                        type: "post",
                        url: "/discussdelect/"+discuss_id,
                        dataType: "json",
                        contentType: "application/json;charset=UTF-8",
                        success: function (data) {
                            if (data > 0) {
                                window.location.reload();
                            }
                        }
                    })
                });
                var i;
                $(".d_di_di").click(function () {
                    var zan_discuss_id=$(this).children('#d2').val();
                    zan_discuss_id=parseInt(zan_discuss_id);
                    var play = $(this).children('#d3').val();
                    play=parseInt(play);
                    if (play == 0) {
                        i = $(this).children('.d11').html();
                        i = parseInt(i) + 1;
                        $(this).children('#d1').attr("src", "img/dianzanred.svg");
                        $(this).children('.d11').replaceWith('<a class="d11">' + i + '</a>');
                        $(this).children('#d3').val(1);
                        $.ajax({
                            type: "post",
                            url: "/zanadd/" + user_id+"/"+music_id+"/"+zan_discuss_id,                        //音乐id
                            dataType: "json",
                            contentType: "application/json;charset=UTF-8",
                            success: function (data) {}
                        })
                    } else {
                        i = $(this).children('.d11').html();
                        i = parseInt(i) - 1;
                        $(this).children('#d1').attr("src", "img/dianzanbai.svg");
                        $(this).children('.d11').replaceWith('<a class="d11">' + i + '</a>');
                        $(this).children('#d3').val(0);
                        $.ajax({
                            type: "post",
                            url: "/zandel/" + user_id+"/"+music_id+"/"+zan_discuss_id,                        //音乐id
                            dataType: "json",
                            contentType: "application/json;charset=UTF-8",
                            success: function (data) {}
                        })
                    }
                });
                $("#tijiao").click(function () {
                    var content = $(".dcontent").val();
                    if(content==null||content==""){
                        alert("请输入内容");
                        return;
                    }
                    $.ajax({
                        type: "Post",
                        url: "/discussinsert/" + content + "/" + "/" + user_id + "/" + "/" + music_id,
                        dataType: "json",
                        contentType: "application/json;charset=UTF-8",
                        success: function (data) {
                            if (data > 0) {
                                window.location.reload();
                            }
                        }
                    })
                })
            }
        });
    });
    $(window).resize(function () {
        $('body').css('height', $(window).height());
    });
</script>

